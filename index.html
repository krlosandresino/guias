<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de guias</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #f4f7f6; 
            color: #333; 
            display: flex; 
            justify-content: center; 
            padding: 20px; 
            margin: 0;
            user-select: none;
        }

        .card { 
            background: #ffffff; 
            padding: 2rem; 
            border-radius: 12px; 
            width: 100%; 
            max-width: 550px; 
            border: 1px solid #e0e0e0; 
            position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        
        .contador-badge { 
            position: absolute; 
            top: 15px; 
            right: 15px; 
            background: #2e7d32; 
            color: white; 
            padding: 5px 15px; 
            border-radius: 20px; 
            font-weight: bold; 
            font-size: 0.85rem; 
        }
        
        h1 { text-align: center; color: #1a1a1a; font-size: 1.5rem; margin-bottom: 1.5rem; }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #eee;
        }

        .stat-card { 
            text-align: center; 
            display: flex; 
            flex-direction: column; 
            position: relative;
            padding-bottom: 5px;
        }
        .stat-val { font-size: 1.2rem; font-weight: bold; margin-bottom: 2px; }
        .stat-label { font-size: 0.65rem; font-weight: bold; text-transform: uppercase; color: #666; }
        
        /* Bot√≥n para limpiar courier individual */
        .btn-clear-mini {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 10px;
            cursor: pointer;
            margin-top: 5px;
            color: #d32f2f;
            padding: 2px 0;
            transition: all 0.2s;
        }
        .btn-clear-mini:hover { background: #fee; border-color: #d32f2f; }

        .val-urbano { color: #f44336; }
        .val-laar { color: #ff9800; }
        .val-servi { color: #4caf50; }

        .input-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
        .input-row { display: flex; gap: 8px; }
        
        input { 
            flex: 1; padding: 12px; border-radius: 6px; border: 1px solid #ccc; font-size: 16px; outline: none; 
        }
        input:focus { border-color: #4caf50; }
        
        input.error-input { 
            border-color: #d32f2f; background-color: #ffebee; animation: shake 0.3s;
        }
        
        .error-msg {
            color: #d32f2f; font-size: 0.75rem; margin-top: -5px; display: none; font-weight: bold;
        }

        .cloud-status {
            font-size: 0.7rem; text-align: center; height: 15px; margin-top: -15px; margin-bottom: 10px; font-weight: bold; color: #999;
        }

        .btn-add { 
            padding: 12px 20px; background-color: #4caf50; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; 
        }

        .actions { display: flex; gap: 8px; margin-top: 20px; }
        .btn-download { flex: 2; padding: 10px; background-color: #1976D2; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .btn-clear { flex: 1; padding: 10px; background-color: #f5f5f5; color: #d32f2f; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; }
        
        #listaGuias { 
            display: flex; flex-direction: column; gap: 8px; margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px; max-height: 350px; overflow-y: auto; 
        }

        .guia-item { 
            display: grid; grid-template-columns: 130px 1fr 140px; align-items: center; background: #f9f9f9; padding: 10px; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 0.85rem; border: 1px solid #eee; 
        }

        .badge-courier {
            font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; color: white; font-weight: bold; width: 80px; text-align: center;
        }

        .courier-urbano { background-color: #f44336; }
        .courier-laar { background-color: #ff9800; }
        .courier-servi { background-color: #4caf50; }

        .hora-texto { color: #888; font-size: 0.75rem; text-align: center; }
        .guia-texto { font-weight: bold; }
        
        .btn-delete {
            background: none; border: none; color: #d32f2f; cursor: pointer; font-size: 1.1rem; padding: 0 5px; transition: transform 0.1s;
        }
        .btn-delete:hover { transform: scale(1.2); }

        .badge-repetida {
            background-color: #d32f2f; color: white; font-size: 0.6rem; padding: 1px 4px; border-radius: 4px; font-weight: bold; margin-right: 5px;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }
    </style>
</head>
<body>

<div class="card">
    <div class="contador-badge">TOTAL: <span id="numContador">0</span></div>
    <h1>üì¶ Registro de Gu√≠as</h1>

    <div class="stats-container">
        <div class="stat-card">
            <span class="stat-val val-urbano" id="stat-urbano">0</span>
            <span class="stat-label">Urbano</span>
            <button class="btn-clear-mini" onclick="limpiarCourier('URBANO')">Limpiar</button>
        </div>
        <div class="stat-card">
            <span class="stat-val val-laar" id="stat-laar">0</span>
            <span class="stat-label">Laar</span>
            <button class="btn-clear-mini" onclick="limpiarCourier('LAAR')">Limpiar</button>
        </div>
        <div class="stat-card">
            <span class="stat-val val-servi" id="stat-servi">0</span>
            <span class="stat-label">Servi</span>
            <button class="btn-clear-mini" onclick="limpiarCourier('SERVIENTREGA')">Limpiar</button>
        </div>
    </div>
    
    <div class="input-group">
        <div class="input-row">
            <input type="text" id="nuevaGuia" placeholder="Escanee gu√≠a aqu√≠..." autofocus autocomplete="off">
            <button class="btn-add" onclick="agregarGuia()">A√±adir</button>
        </div>
        <span id="mensajeError" class="error-msg">‚ùå Gu√≠a INV√ÅLIDA (Revisar Courier)</span>
    </div>
    
    <div id="statusNube" class="cloud-status">Esperando datos...</div>

    <div id="listaGuias"></div>

    <div class="actions">
        <button class="btn-download" onclick="descargarExcel()">üìä Descargar Excel</button>
        <button class="btn-clear" onclick="limpiarTodo()">üóëÔ∏è Limpiar Todo</button>
    </div>
</div>

<script>
    const URL_GOOGLE_SHEET = "https://script.google.com/macros/s/AKfycbzXMgPjNaY0LrZNXPyzDgNcI9Zfdmnfj8nMUVNBv-roS4KYestgXWElx4jwqoE2pwv0tA/exec";

    let datosGuias = [];
    const input = document.getElementById('nuevaGuia');
    const contenedor = document.getElementById('listaGuias');
    const txtContador = document.getElementById('numContador');
    const sUrbano = document.getElementById('stat-urbano');
    const sLaar = document.getElementById('stat-laar');
    const sServi = document.getElementById('stat-servi');
    const statusNube = document.getElementById('statusNube');

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    window.onload = function() {
        const guardado = localStorage.getItem('misGuias');
        if (guardado) {
            datosGuias = JSON.parse(guardado);
            renderizarLista();
            actualizarContador();
        }
    };

    function sonar(frecuencia, tipo, duracion, volumen) {
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.type = tipo;
        oscillator.frequency.setValueAtTime(frecuencia, audioCtx.currentTime);
        gainNode.gain.setValueAtTime(volumen, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duracion);
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        oscillator.start();
        oscillator.stop(audioCtx.currentTime + duracion);
    }

    function sonarRepetida() {
        sonar(600, 'square', 0.2, 0.1);
        setTimeout(() => sonar(600, 'square', 0.2, 0.1), 150);
    }

    function sonarInvalida() { sonar(100, 'sawtooth', 0.6, 0.3); }
    function sonarOk() { sonar(800, 'sine', 0.1, 0.05); }

    function guardarEnStorage() {
        localStorage.setItem('misGuias', JSON.stringify(datosGuias));
    }

    function enviarANube(datos) {
        if (!URL_GOOGLE_SHEET) return;
        statusNube.innerText = "‚òÅÔ∏è Enviando a la nube...";
        statusNube.style.color = "#1976D2";
        fetch(URL_GOOGLE_SHEET, {
            method: 'POST',
            mode: 'no-cors', 
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify(datos)
        })
        .then(() => {
            statusNube.innerText = "‚úÖ Guardado en la nube";
            statusNube.style.color = "green";
            setTimeout(() => { statusNube.innerText = "Esperando datos..."; statusNube.style.color = "#999"; }, 2000);
        })
        .catch(error => {
            console.error('Error:', error);
            statusNube.innerText = "‚ùå Error de conexi√≥n";
            statusNube.style.color = "red";
        });
    }

    function eliminarGuia(indexVisual) {
        if (confirm("¬øEliminar este registro localmente? (No se borrar√° de la nube)")) {
            const indexReal = datosGuias.length - 1 - indexVisual;
            datosGuias.splice(indexReal, 1);
            guardarEnStorage();
            renderizarLista();
            actualizarContador();
        }
    }

    // --- NUEVA FUNCI√ìN PARA LIMPIAR SOLO UN COURIER ---
    function limpiarCourier(courier) {
        const cantidad = datosGuias.filter(g => g.Courier === courier).length;
        if (cantidad === 0) return;

        if (confirm(`¬øSeguro que quieres borrar localmente las ${cantidad} gu√≠as de ${courier}?`)) {
            // Filtramos para quedarnos solo con lo que NO sea el courier seleccionado
            datosGuias = datosGuias.filter(g => g.Courier !== courier);
            guardarEnStorage();
            renderizarLista();
            actualizarContador();
            input.focus();
        }
    }

    function renderizarLista() {
        contenedor.innerHTML = "";
        [...datosGuias].reverse().forEach((g, idx) => {
            const div = document.createElement('div');
            div.className = 'guia-item';
            
            let courierClass = '';
            if(g.Courier === 'URBANO') courierClass = 'courier-urbano';
            if(g.Courier === 'LAAR') courierClass = 'courier-laar';
            if(g.Courier === 'SERVIENTREGA') courierClass = 'courier-servi';

            div.innerHTML = `
                <div class="guia-texto">${g.Guia}</div>
                <div class="hora-texto">${g.Hora}</div>
                <div style="display: flex; align-items: center; justify-content: flex-end; gap: 8px;">
                    ${g.Estado === "REPETIDA" ? '<span class="badge-repetida">REP</span>' : ''}
                    <span class="badge-courier ${courierClass}">${g.Courier}</span>
                    <button class="btn-delete" onclick="eliminarGuia(${idx})" title="Borrar">üóëÔ∏è</button>
                </div>
            `;
            contenedor.appendChild(div);
        });
    }

    function actualizarContador() {
        txtContador.textContent = datosGuias.length;
        sUrbano.textContent = datosGuias.filter(g => g.Courier === 'URBANO').length;
        sLaar.textContent = datosGuias.filter(g => g.Courier === 'LAAR').length;
        sServi.textContent = datosGuias.filter(g => g.Courier === 'SERVIENTREGA').length;
    }

    function validarGuia(valor) {
        if (valor.length === 11 && valor.startsWith("41")) return "URBANO";
        if (valor.length === 10 && valor.startsWith("20")) return "LAAR";
        if (valor.length === 9 && valor.startsWith("81")) return "SERVIENTREGA";
        return null;
    }

    function agregarGuia() {
        const valor = input.value.trim().toUpperCase();
        if (valor === "") return;

        const courierIdentificado = validarGuia(valor);

        if (!courierIdentificado) {
            sonarInvalida();
            document.getElementById('mensajeError').style.display = "block";
            input.classList.add('error-input');
            setTimeout(() => {
                input.classList.remove('error-input');
                document.getElementById('mensajeError').style.display = "none";
            }, 1500);
            return;
        }

        const existe = datosGuias.some(g => g["Guia"] === valor);
        const ahora = new Date();
        const fechaLimpia = ahora.toLocaleDateString();
        const horaLimpia = ahora.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        let nuevaData = { 
            "Guia": valor, 
            "Courier": courierIdentificado, 
            "Fecha": fechaLimpia, 
            "Hora": horaLimpia, 
            "Estado": "NUEVA" 
        };

        if (existe) {
            sonarRepetida();
            input.classList.add('error-input');
            setTimeout(() => input.classList.remove('error-input'), 500);
            nuevaData.Estado = "REPETIDA";
            datosGuias.push(nuevaData);
        } else {
            sonarOk();
            datosGuias.push(nuevaData);
        }
        
        enviarANube(nuevaData);
        guardarEnStorage(); 
        renderizarLista();
        actualizarContador();
        input.value = "";
        input.focus();
    }

    function descargarExcel() {
        if (datosGuias.length === 0) return alert("No hay gu√≠as para descargar");
        const ahora = new Date();
        const nombreArchivo = `Reporte_Guias_${ahora.getFullYear()}-${ahora.getMonth()+1}-${ahora.getDate()}.xlsx`;
        const ws = XLSX.utils.json_to_sheet(datosGuias);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Reporte");
        XLSX.writeFile(wb, nombreArchivo);
    }

    function limpiarTodo() {
        if (confirm("¬øSeguro que quieres borrar todo el trabajo actual LOCALMENTE? (La nube no se borrar√°)")) {
            datosGuias = [];
            localStorage.removeItem('misGuias');
            renderizarLista();
            actualizarContador();
            input.focus();
        }
    }

    input.addEventListener("keypress", (e) => { if (e.key === "Enter") agregarGuia(); });
    document.addEventListener('contextmenu', e => e.preventDefault());
</script>
</body>
</html>
